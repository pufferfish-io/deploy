---
name: "ðŸš€ Deploy Ingress: demo.pufferfish.ru"
on:
  push:
    paths:
      - k8s/ingress/hello-demo-ingress.yaml
  workflow_dispatch: null
jobs:
  apply-ingress:
    name: ðŸ”„ Apply Ingress for demo
    runs-on: self-hosted
    env:
      KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4
      - name: ðŸ”§ Ensure namespace
        run: |
          kubectl get ns demo || kubectl create ns demo
      - name: ðŸ“¦ Apply demo backend (hello-service)
        run: |
          # Ð Ð°Ð·Ð²Ð¾Ñ€Ð°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ backend, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ 503
          kubectl -n demo apply -f k8s/ingress/hello-demo-backend.yaml
      - name: â³ Wait backend rollout
        run: |
          kubectl -n demo rollout status deployment/hello-demo --timeout=180s
      - name: "ðŸ“¤ Deploy Ingress: demo.pufferfish.ru"
        run: |
          echo "â³ Applying Ingress..."
          kubectl apply -f k8s/ingress/hello-demo-ingress.yaml
      - name: ðŸ“‹ Show ingress
        run: |
          echo "âœ… Ingresses in demo namespace:"
          kubectl get ingress -n demo -o wide
      - name: ðŸ” Wait for Certificate (demo-tls)
        run: |
          set -e
          # Ð¶Ð´Ñ‘Ð¼ Ð¿Ð¾ÑÐ²Ð»ÐµÐ½Ð¸Ñ Ñ€ÐµÑÑƒÑ€ÑÐ°
          for i in $(seq 1 60); do
            kubectl -n demo get certificate demo-tls && break || true
            sleep 5
            if [ "$i" -eq 60 ]; then echo "âŒ certificate/demo-tls not created"; exit 1; fi
          done
          # Ð¶Ð´Ñ‘Ð¼ Ð³Ð¾Ñ‚Ð¾Ð²Ð½Ð¾ÑÑ‚Ð¸
          kubectl -n demo wait --for=condition=Ready certificate/demo-tls --timeout=10m
          kubectl -n demo get certificate
          echo "Secret type:" $(kubectl -n demo get secret demo-tls -o jsonpath='{.type}')
      - name: ðŸ”Ž Orders/Challenges (debug)
        continue-on-error: true
        run: |
          kubectl -n demo get orders.acme.cert-manager.io -o wide || true
          kubectl -n demo get challenges.acme.cert-manager.io -o wide || true
      - name: âœ… TLS check (best effort)
        continue-on-error: true
        run: |
          echo "Certificate info (subject/issuer):"
          echo | openssl s_client -connect demo.pufferfish.ru:443 -servername demo.pufferfish.ru 2>/dev/null | openssl x509 -noout -subject -issuer -dates || true
          echo "HTTP probe over HTTPS (status may be 200/301/308/404):"
          curl -I --max-time 10 https://demo.pufferfish.ru || true
