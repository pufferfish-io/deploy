name: ðŸš€ Deploy MinIO

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: [self-hosted]
    steps:
      - name: ðŸ§¾ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ§± Preflight: ensure CoreDNS split-DNS (*.pufferfish.ru)
        continue-on-error: true
        env:
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          set -euo pipefail
          if [ -f scripts/coredns-wildcard-pufferfish.sh ]; then
            chmod +x scripts/coredns-wildcard-pufferfish.sh
            # Idempotent: updates/creates template block for *.pufferfish.ru and restarts CoreDNS
            ./scripts/coredns-wildcard-pufferfish.sh || true
          else
            echo "No scripts/coredns-wildcard-pufferfish.sh found; skipping split-DNS preflight"
          fi

      - name: ðŸ”Ž Preflight: in-cluster DNS for public domains
        env:
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          set -euo pipefail
          echo "Check that public domains resolve to ingress ClusterIP in-cluster"
          INGRESS_IP=$(kubectl -n ingress-nginx get svc ingress-nginx-controller -o jsonpath='{.spec.clusterIP}')
          echo "Expected ingress ClusterIP: ${INGRESS_IP}"
          kubectl -n minio delete pod dns-preflight --ignore-not-found=true >/dev/null 2>&1 || true
          kubectl -n minio run dns-preflight --restart=Never --image=busybox:1.36 -- sleep 90 >/dev/null 2>&1
          kubectl -n minio wait --for=condition=Ready pod/dns-preflight --timeout=90s
          OUT=$(kubectl -n minio exec dns-preflight -- sh -lc "nslookup backminio.pufferfish.ru; echo; nslookup consoleminio.pufferfish.ru")
          kubectl -n minio delete pod dns-preflight --now --ignore-not-found=true >/dev/null 2>&1 || true
          echo "$OUT"
          # Must see ingress IP at least twice (both names)
          cnt=$(printf "%s" "$OUT" | grep -c "Address: ${INGRESS_IP}") || true
          if [ "$cnt" -lt 2 ]; then
            echo "âŒ In-cluster DNS for public domains is not pointing to ingress (${INGRESS_IP}). Fix CoreDNS/DNS before deploy." >&2
            exit 1
          fi

      - name: ðŸš€ Deploy MinIO via Helm (wait + atomic)
        env:
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
          MINIO_ROOT_USER: ${{ secrets.MINIO_ROOT_USER }}
          MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}
        run: |
          set -euo pipefail
          helm repo add minio https://charts.min.io/
          helm repo update
          helm upgrade --install minio minio/minio \
            --namespace minio --create-namespace \
            --values k8s/minio/values-prod.yaml \
            --set auth.rootUser="${MINIO_ROOT_USER}" \
            --set auth.rootPassword="${MINIO_ROOT_PASSWORD}" \
            --wait --wait-for-jobs --atomic \
            --timeout 20m

      - name: â³ Wait MinIO pods Ready + diagnostics
        env:
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          set -euo pipefail
          echo "â–¶ï¸ Live status while waiting for MinIO pods to be Ready..."
          (
            while true; do
              echo "===== $(date) ====="
              echo "Pods:"; kubectl -n minio get pods -o wide || true
              echo "Services:"; kubectl -n minio get svc -o wide || true
              echo "Recent events:"; kubectl -n minio get events --sort-by=.lastTimestamp | tail -n 20 || true
              sleep 15
            done
          ) & MON=$!
          trap 'kill $MON 2>/dev/null || true' EXIT

          # Wait for any minio pods to become Ready (label: app=minio)
          kubectl -n minio wait --for=condition=Ready pod -l app=minio --timeout=10m
          kill $MON 2>/dev/null || true; trap - EXIT
          kubectl -n minio get pods -o wide

      - name: ðŸ”Œ Service reachability (minio:9000)
        env:
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          set -euo pipefail
          SVC_IP=$(kubectl -n minio get svc minio -o jsonpath='{.spec.clusterIP}')
          echo "Expected Service IP: ${SVC_IP}"
          kubectl -n minio delete pod svc-check --ignore-not-found=true >/dev/null 2>&1 || true
          kubectl -n minio run svc-check --restart=Never --image=busybox:1.36 -- sleep 60 >/dev/null 2>&1
          kubectl -n minio wait --for=condition=Ready pod/svc-check --timeout=90s
          OUT=$(kubectl -n minio exec svc-check -- sh -lc "nslookup minio.minio.svc.cluster.local; echo; nc -zv minio 9000 || true")
          kubectl -n minio delete pod svc-check --now --ignore-not-found=true >/dev/null 2>&1 || true
          echo "$OUT"
          echo "$OUT" | grep -q "Address: ${SVC_IP}"
          echo "$OUT" | grep -qi "succeeded\|open"

      - name: ðŸ“‹ Show ingresses
        env:
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          kubectl -n minio get ingress -o wide || true

      - name: ðŸ“ Helm status + post-job summary
        env:
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          set -euo pipefail
          helm status minio -n minio || true
          kubectl -n minio get jobs -o wide || true
          kubectl -n minio wait --for=condition=complete job/minio-post-job --timeout=10m || true
          kubectl -n minio logs job/minio-post-job --tail=200 || true

      - name: ðŸ” Wait for Certificates (minio/console)
        env:
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          set -e
          # Wait for resources to appear
          for name in minio-tls minio-console-tls; do
            for i in $(seq 1 60); do
              kubectl -n minio get certificate "$name" && break || true
              sleep 5
              if [ "$i" -eq 60 ]; then echo "âŒ certificate/$name not created"; exit 1; fi
            done
            kubectl -n minio wait --for=condition=Ready certificate/"$name" --timeout=20m
          done
          kubectl -n minio get certificate

      - name: ðŸ” ACME debug (orders/challenges)
        continue-on-error: true
        env:
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          set -euo pipefail
          kubectl -n minio get orders.acme.cert-manager.io -o wide || true
          kubectl -n minio get challenges.acme.cert-manager.io -o wide || true
          kubectl -n cert-manager logs deploy/cert-manager --since=15m | egrep -i "pufferfish|minio|acme|challenge|http-01" || true

      - name: âœ… TLS check (best effort)
        continue-on-error: true
        env:
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          echo "Certificate info (minio API):"
          echo | openssl s_client -connect backminio.pufferfish.ru:443 -servername backminio.pufferfish.ru 2>/dev/null | openssl x509 -noout -subject -issuer -dates || true
          echo "HTTP probe over HTTPS (API):"
          curl -I --max-time 15 https://backminio.pufferfish.ru || true
          echo "Certificate info (console):"
          echo | openssl s_client -connect consoleminio.pufferfish.ru:443 -servername consoleminio.pufferfish.ru 2>/dev/null | openssl x509 -noout -subject -issuer -dates || true
          echo "HTTP probe over HTTPS (console):"
          curl -I --max-time 15 https://consoleminio.pufferfish.ru || true
