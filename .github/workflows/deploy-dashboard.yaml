---
name: "ðŸš€ Deploy Dashboard: dashboard.k3s.pufferfish.ru"
on:
  workflow_dispatch: null
jobs:
  apply-dashboard:
    name: ðŸ”„ Apply Dashboard + Ingress
    runs-on: self-hosted
    env:
      KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    steps:
      - name: ðŸ§¾ Checkout repository
        uses: actions/checkout@v4
      - name: ðŸ”§ Ensure namespace
        run: |
          kubectl get ns kubernetes-dashboard || kubectl create ns kubernetes-dashboard
      - name: ðŸ” Ensure CSRF token secret
        env:
          CSRF_SECRET: ${{ secrets.DASHBOARD_K3S_CSRF_TOKEN }}
        run: |
          printf '%s' "$CSRF_SECRET" | kubectl -n kubernetes-dashboard create secret generic kubernetes-dashboard-csrf --from-file=csrf=/dev/stdin --dry-run=client -o yaml | kubectl apply -f -
      - name: ðŸ“¦ Apply Kubernetes Dashboard
        run: |
          kubectl apply -f k8s/dashboard/deploy.yaml
      - name: â³ Wait dashboard rollout
        run: |
          kubectl -n kubernetes-dashboard rollout status deployment/kubernetes-dashboard --timeout=180s
      - name: "ðŸ“¤ Deploy Ingress: dashboard.k3s.pufferfish.ru"
        run: |
          kubectl apply -f k8s/ingress/dashboard-ingress.yaml
      - name: ðŸ“‹ Show ingress
        run: |
          echo "âœ… Dashboard ingress in kubernetes-dashboard namespace:" \
            && kubectl get ingress -n kubernetes-dashboard -o wide
      - name: ðŸ”§ Ensure cert-manager hostAlias for dashboard.k3s.pufferfish.ru
        shell: bash
        run: |
          DOMAIN="dashboard.k3s.pufferfish.ru"
          NODE_IP=$(kubectl get node -o jsonpath='{.items[0].status.addresses[?(@.type=="InternalIP")].address}')
          echo "Using NODE_IP=${NODE_IP} for ${DOMAIN}"
          kubectl -n cert-manager patch deploy cert-manager --type='json' -p="[
            {
              \"op\": \"replace\",
              \"path\": \"/spec/template/spec/hostAliases\",
              \"value\": [
                {
                  \"ip\": \"${NODE_IP}\",
                  \"hostnames\": [\"${DOMAIN}\"]
                }
              ]
            }
          ]"
          kubectl -n cert-manager rollout restart deploy/cert-manager
          kubectl -n cert-manager rollout status deploy/cert-manager --timeout=120s
      - name: ðŸ” TLS certificate check (non-blocking)
        continue-on-error: true
        run: |
          set -e
          kubectl -n kubernetes-dashboard get certificate || true
          kubectl -n kubernetes-dashboard get orders.acme.cert-manager.io -o wide || true
          kubectl -n kubernetes-dashboard get challenges.acme.cert-manager.io -o wide || true
          echo "Certificate info (if any):"
          echo | openssl s_client -connect dashboard.k3s.pufferfish.ru:443 -servername dashboard.k3s.pufferfish.ru 2>/dev/null | openssl x509 -noout -subject -issuer -dates || true
          echo "HTTP probe over HTTPS:"
          curl -I --max-time 10 https://dashboard.k3s.pufferfish.ru || true
