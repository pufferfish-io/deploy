name: "üöÄ Deploy MinIO (cpuv1) + TLS"

on:
  workflow_dispatch:
  push:
    paths:
      - "k8s/minio/**"

env:
  # Kubernetes context
  KUBECONFIG: /etc/rancher/k3s/k3s.yaml

  # CPU v1 image ‚Äî –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–∞—è —Ä–∞–±–æ—á–∞—è
  MINIO_IMAGE: quay.io/minio/minio:RELEASE.2021-04-22T15-44-28Z

  # Secrets (repo > org)
  MINIO_ROOT_USER: ${{ secrets.MINIO_ROOT_USER }}
  MINIO_ROOT_PASSWORD: ${{ secrets.MINIO_ROOT_PASSWORD }}
  S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
  S3_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}

jobs:
  deploy-minio:
    runs-on: self-hosted

    steps:
      # ----------------------
      # ‚úÖ 1. Checkout
      # ----------------------
      - name: üì• Checkout repository
        uses: actions/checkout@v4

      # ----------------------
      # ‚úÖ 2. Validate secrets
      # ----------------------
      - name: üîé Check required secrets
        run: |
          echo "Checking MINIO secrets..."
          for v in MINIO_ROOT_USER MINIO_ROOT_PASSWORD; do
            if [ -z "${!v}" ]; then
               echo "‚ùå Secret $v is empty. Set it in repo or org secrets."
               exit 1
            fi
          done
          echo "‚úÖ Secrets OK"

      # ----------------------
      # ‚úÖ 3. Create namespace
      # ----------------------
      - name: üì¶ Ensure namespace exists
        run: |
          kubectl get ns minio || kubectl create ns minio

      # ----------------------
      # ‚úÖ 4. Kubernetes secret (root credentials)
      # ----------------------
      - name: üîê Apply Kubernetes secret
        run: |
          kubectl -n minio delete secret minio-root --ignore-not-found
          kubectl -n minio create secret generic minio-root \
            --from-literal=MINIO_ROOT_USER="$MINIO_ROOT_USER" \
            --from-literal=MINIO_ROOT_PASSWORD="$MINIO_ROOT_PASSWORD"

      # ----------------------
      # ‚úÖ 5. Apply manifests
      # ----------------------
      - name: üìú Apply manifests
        run: |
          kubectl apply -f k8s/minio/namespace.yaml
          kubectl apply -f k8s/minio/pvc.yaml
          kubectl apply -f k8s/minio/deploy.yaml
          kubectl apply -f k8s/minio/svc.yaml
          kubectl apply -f k8s/minio/ingress.yaml

      # ----------------------
      # ‚úÖ 6. Wait for rollout
      # ----------------------
      - name: ‚è≥ Wait for rollout
        run: |
          kubectl -n minio rollout status deploy/minio --timeout=300s