name: üöÄ Deploy telegram-forwarder

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Image tag to deploy (defaults to latest)"
        required: false
        default: "latest"
      image_repo:
        description: "Container image repository"
        required: false
        default: "ghcr.io/pufferfish-io/telegram-forwarder"

jobs:
  deploy:
    name: üîÑ Deploy via Helm
    runs-on: self-hosted

    env:
      KUBECONFIG: /etc/rancher/k3s/k3s.yaml

    steps:
      - name: üßæ Checkout repo
        uses: actions/checkout@v4

      - name: üîß Ensure namespace
        run: |
          kubectl get ns app || kubectl create ns app

      - name: üîê Apply/update env Secret
        env:
          ADDR: ":8080"
          BOOTSTRAP: ${{ secrets.TG_FORWARDER_KAFKA_BOOTSTRAP_SERVERS_VALUE }}
          TOPIC: ${{ secrets.TG_FORWARDER_KAFKA_TG_MESS_TOPIC_NAME }}
          SASL_USER: ${{ secrets.TG_FORWARDER_KAFKA_SASL_USERNAME }}
          SASL_PASS: ${{ secrets.TG_FORWARDER_KAFKA_SASL_PASSWORD }}
          TG_TOKEN: ${{ secrets.TG_FORWARDER_TELEGRAM_TOKEN }}
          WEBHOOK_PATH: ${{ secrets.TG_FORWARDER_API_TG_WEB_HOOK_PATH }}
          HEALTH_PATH: ${{ secrets.TG_FORWARDER_API_HEALTH_CHECK_PATH }}
        run: |
          kubectl -n app create secret generic telegram-forwarder-env \
            --from-literal=TG_FORWARDER_SERVER_ADDR="${ADDR:-:8080}" \
            --from-literal=TG_FORWARDER_KAFKA_BOOTSTRAP_SERVERS_VALUE="${BOOTSTRAP}" \
            --from-literal=TG_FORWARDER_KAFKA_TG_MESS_TOPIC_NAME="${TOPIC}" \
            --from-literal=TG_FORWARDER_KAFKA_SASL_USERNAME="${SASL_USER}" \
            --from-literal=TG_FORWARDER_KAFKA_SASL_PASSWORD="${SASL_PASS}" \
            --from-literal=TG_FORWARDER_TELEGRAM_TOKEN="${TG_TOKEN}" \
            --from-literal=TG_FORWARDER_API_TG_WEB_HOOK_PATH="${WEBHOOK_PATH:-/telegram/webhook}" \
            --from-literal=TG_FORWARDER_API_HEALTH_CHECK_PATH="${HEALTH_PATH:-/healthz}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: üì§ Apply manifests
        run: |
          kubectl -n app apply -f k8s/telegram-forwarder/deploy.yaml

      - name: üñº Update image tag
        env:
          IMAGE_TAG: ${{ github.event.inputs.image_tag }}
          IMAGE_REPO: ${{ github.event.inputs.image_repo }}
        run: |
          TAG=${IMAGE_TAG:-latest}
          REPO=${IMAGE_REPO:-ghcr.io/pufferfish-io/telegram-forwarder}
          IMAGE="${REPO}:${TAG}"
          echo "Deploying image: ${IMAGE}"
          kubectl -n app set image deployment/telegram-forwarder telegram-forwarder=${IMAGE}
      - name: üîé Rollout status
        run: |
          set -e
          kubectl -n app rollout status deployment/telegram-forwarder --timeout=120s
          kubectl -n app get pods -o wide
      - name: üìù Recent logs (best effort)
        continue-on-error: true
        run: |
          kubectl -n app logs deploy/telegram-forwarder --tail=200 --insecure-skip-tls-verify-backend
