name: "ğŸš€ Deploy Keycloak + Ingress: auth.pufferfish.ru"

on:
  workflow_dispatch:

jobs:
  apply-ingress:
    name: "ğŸ”„ Deploy Keycloak and apply Ingress"
    runs-on: self-hosted
    env:
      KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      KEYCLOAK_ADMIN_USER: ${{ secrets.KEYCLOAK_ADMIN_USER }}
      KEYCLOAK_ADMIN_PASSWORD: ${{ secrets.KEYCLOAK_ADMIN_PASSWORD }}
      HELM_EXPERIMENTAL_OCI: "1"

    steps:
      - name: "ğŸ§¾ Checkout repository"
        uses: actions/checkout@v4
      - name: ğŸ”§ Ensure namespace
        run: |
          kubectl get ns auth || kubectl create ns auth

      - name: "ğŸ“¦ Deploy/Upgrade Keycloak (Helm)"
        run: |
          set -euo pipefail
          if [ -z "${KEYCLOAK_ADMIN_USER:-}" ] || [ -z "${KEYCLOAK_ADMIN_PASSWORD:-}" ]; then
            echo "âŒ Missing secrets: set KEYCLOAK_ADMIN_USER and KEYCLOAK_ADMIN_PASSWORD in repo secrets" >&2
            exit 1
          fi

          echo "ğŸ” Creating/Updating Secret: keycloak-admin"
          # Creates/updates Secret with admin creds (idempotent)
          kubectl -n auth create secret generic keycloak-admin \
            --from-literal=admin-user="${KEYCLOAK_ADMIN_USER}" \
            --from-literal=admin-password="${KEYCLOAK_ADMIN_PASSWORD}" \
            --dry-run=client -o yaml | kubectl apply -f -

          echo "â³ Installing/Upgrading Bitnami Keycloak chart (OCI)..."
          helm version || true
          # Use OCI registry to avoid blocked HTTP helm repo (403 in some regions)
          # Docs: https://github.com/bitnami/charts/tree/main/bitnami/keycloak#oci-registry
          # Chart: oci://registry-1.docker.io/bitnamicharts/keycloak
          # Notes:
          # - postgresql.enabled=true: uses embedded PostgreSQL (auto-generated credentials)
          # - proxy=edge: proper X-Forwarded-* handling behind ingress-nginx
          # - we keep ingress disabled here; we use our own manifest k8s/ingress/keycloak-ingress.yaml
          helm upgrade --install keycloak oci://registry-1.docker.io/bitnamicharts/keycloak \
            --namespace auth --create-namespace \
            --set production=true \
            --set proxyHeaders=xforwarded \
            --set auth.existingSecret=keycloak-admin \
            --set proxy=edge \
            --set postgresql.enabled=true \
            --wait --timeout 15m

      - name: "â³ Wait for Keycloak pods Ready"
        run: |
          set -e
          # Wait for any pod of this release to become Ready
          kubectl -n auth wait --for=condition=Ready pod -l app.kubernetes.io/instance=keycloak --timeout=10m
          kubectl -n auth get pods -l app.kubernetes.io/instance=keycloak -o wide

      - name: "ğŸ“¤ Deploy Ingress: auth.pufferfish.ru"
        run: |
          echo "â³ Applying Keycloak Ingress..."
          kubectl apply -f k8s/ingress/keycloak-ingress.yaml

      - name: "ğŸ” Wait for Certificate (keycloak-tls)"
        run: |
          set -e
          for i in $(seq 1 60); do
            kubectl -n auth get certificate keycloak-tls && break || true
            sleep 5
            if [ "$i" -eq 60 ]; then echo "âŒ certificate/keycloak-tls not created"; exit 1; fi
          done
          kubectl -n auth wait --for=condition=Ready certificate/keycloak-tls --timeout=10m
          kubectl -n auth get certificate
          echo "Secret type:" $(kubectl -n auth get secret keycloak-tls -o jsonpath='{.type}')

      - name: "ğŸ” Orders/Challenges (debug)"
        continue-on-error: true
        run: |
          kubectl -n auth get orders.acme.cert-manager.io -o wide || true
          kubectl -n auth get challenges.acme.cert-manager.io -o wide || true

      - name: "ğŸ“‹ Show result"
        run: |
          echo "âœ… Ingresses in auth namespace:"
          kubectl get ingress -n auth -o wide
          echo "ğŸŒ HTTP probe over HTTPS (auth.pufferfish.ru):"
          curl -I --max-time 15 https://auth.pufferfish.ru || true
