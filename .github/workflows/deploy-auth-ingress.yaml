name: "ğŸš€ Deploy Official Keycloak + Ingress: auth.pufferfish.ru"

on:
  workflow_dispatch:

jobs:
  apply-ingress:
    name: "ğŸ”„ Deploy official Keycloak and apply Ingress"
    runs-on: self-hosted
    env:
      KUBECONFIG: /etc/rancher/k3s/k3s.yaml
      KC_IMAGE: quay.io/keycloak/keycloak:20.0.5
      KC_ADMIN_USER: admin
      KC_HOST: auth.pufferfish.ru
      KC_ADMIN_PASSWORD: ${{ secrets.KEYCLOAK_ADMIN_PASSWORD }}

    steps:
      - name: "ğŸ§¾ Checkout repository"
        uses: actions/checkout@v4
      - name: ğŸ”§ Ensure namespace
        run: |
          kubectl get ns auth || kubectl create ns auth

      - name: "âœ… Validate inputs/secrets"
        run: |
          set -euo pipefail
          : "${KC_IMAGE:?KC_IMAGE is required}"
          : "${KC_ADMIN_USER:?KC_ADMIN_USER is required}"
          : "${KC_HOST:?KC_HOST is required}"
          : "${KC_ADMIN_PASSWORD:?Set repository secret KEYCLOAK_ADMIN_PASSWORD}"

      - name: "ğŸ” Create/Update admin Secret"
        run: |
          set -euo pipefail
          kubectl -n auth create secret generic kc-admin \
            --from-literal=username="${KC_ADMIN_USER}" \
            --from-literal=password="${KC_ADMIN_PASSWORD}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: "ğŸ“¦ Ensure Keycloak PVC"
        run: |
          set -euo pipefail
          cat <<EOF | kubectl -n auth apply -f -
          apiVersion: v1
          kind: PersistentVolumeClaim
          metadata:
            name: keycloak-data
          spec:
            accessModes: [ReadWriteOnce]
            resources:
              requests:
                storage: 5Gi
          EOF

      - name: "ğŸ“¦ Apply official Keycloak (start-dev)"
        run: |
          set -euo pipefail
          cat <<EOF | kubectl -n auth apply -f -
          apiVersion: v1
          kind: Service
          metadata:
            name: keycloak
            labels: { app: keycloak }
          spec:
            ports: [{ name: http, port: 80, targetPort: 8080 }]
            selector: { app: keycloak }
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata: { name: keycloak }
          spec:
            replicas: 1
            selector: { matchLabels: { app: keycloak } }
            template:
              metadata: { labels: { app: keycloak } }
              spec:
                containers:
                  - name: keycloak
                    image: ${KC_IMAGE}
                    imagePullPolicy: IfNotPresent
                    args: ["start-dev"]
                    env:
                      - name: KEYCLOAK_ADMIN
                        valueFrom: { secretKeyRef: { name: kc-admin, key: username } }
                      - name: KEYCLOAK_ADMIN_PASSWORD
                        valueFrom: { secretKeyRef: { name: kc-admin, key: password } }
                      - { name: KC_PROXY, value: edge }
                      - { name: KC_HOSTNAME, value: ${KC_HOST} }
                      - { name: KC_HEALTH_ENABLED, value: "true" }
                      # Keep memory low for 1Gi node; compatible with 768Mi limit
                      - { name: JAVA_OPTS_APPEND, value: "-Xms256m -Xmx512m -XX:+UseSerialGC -XX:MaxMetaspaceSize=128m" }
                    ports: [{ containerPort: 8080, name: http }]
                    readinessProbe:
                      httpGet: { path: /realms/master, port: http }
                      initialDelaySeconds: 30
                      periodSeconds: 10
                    resources:
                      requests: { cpu: "300m", memory: "512Mi" }
                      limits:   { cpu: "800m", memory: "768Mi" }
                    volumeMounts:
                      - { name: data, mountPath: /opt/keycloak/data }
                volumes:
                  - name: data
                    persistentVolumeClaim:
                      claimName: keycloak-data
          EOF

      - name: "â³ Wait rollout + diagnostics on failure"
        run: |
          set -euo pipefail
          echo "â–¶ï¸ Live status while waiting for rollout..."
          (
            while true; do
              echo "===== $(date) ====="
              echo "Deployment status:"; kubectl -n auth get deploy keycloak -o wide || true
              echo -n "Replicas: "; kubectl -n auth get deploy keycloak -o jsonpath='{.status.readyReplicas}/{.status.replicas} ready, {.status.updatedReplicas} updated, {.status.availableReplicas} available, {.status.unavailableReplicas} unavailable' 2>/dev/null || echo "n/a"; echo
              echo "Pods:"; kubectl -n auth get pods -l app=keycloak -o wide || true
              echo "ReplicaSets:"; kubectl -n auth get rs -l app=keycloak -o wide || true
              echo "Recent events:"; kubectl -n auth get events --sort-by=.lastTimestamp | tail -n 15 || true
              sleep 20
            done
          ) & MON=$!
          trap 'kill $MON 2>/dev/null || true' EXIT

          if ! kubectl -n auth rollout status deploy/keycloak --timeout=10m; then
            kill $MON 2>/dev/null || true; trap - EXIT
            echo "--- Final diagnostics (failure) ---"
            echo "--- Pods:"; kubectl -n auth get pods -l app=keycloak -o wide || true
            echo "--- Describe deploy:"; kubectl -n auth describe deploy/keycloak || true
            echo "--- Describe pods:"; kubectl -n auth describe pods -l app=keycloak || true
            echo "--- Recent events:"; kubectl -n auth get events --sort-by=.lastTimestamp | tail -n 200 || true
            exit 1
          fi
          kill $MON 2>/dev/null || true; trap - EXIT
          kubectl -n auth get pods -l app=keycloak -o wide

      - name: "ğŸ“¤ Deploy Ingress: auth.pufferfish.ru"
        run: |
          echo "â³ Applying Keycloak Ingress..."
          kubectl apply -f k8s/ingress/keycloak-ingress.yaml

      - name: "ğŸ” TLS certificate check (non-blocking)"
        continue-on-error: true
        run: |
          set -e
          kubectl -n auth get certificate || true
          kubectl -n auth get orders.acme.cert-manager.io -o wide || true
          kubectl -n auth get challenges.acme.cert-manager.io -o wide || true
          echo "Certificate info (if any):"
          echo | openssl s_client -connect ${KC_HOST}:443 -servername ${KC_HOST} 2>/dev/null | openssl x509 -noout -subject -issuer -dates || true

      - name: "ğŸ“‹ Show result"
        run: |
          echo "âœ… Ingresses in auth namespace:"
          kubectl get ingress -n auth -o wide
          echo "ğŸŒ HTTP probe over HTTPS (auth.pufferfish.ru):"
          curl -I --max-time 15 https://${KC_HOST} || true
