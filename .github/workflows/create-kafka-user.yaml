name: ðŸ” Create/Update Kafka SCRAM User

on:
  workflow_dispatch: {}

jobs:
  create_user:
    name: ðŸ”„ Ensure SCRAM user exists
    runs-on: self-hosted
    env:
      KUBECONFIG: /etc/rancher/k3s/k3s.yaml
    steps:
      - name: ðŸ§¾ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ”§ Ensure namespace
        run: |
          kubectl get ns app || kubectl create ns app

      - name: â³ Wait for Kafka admin listener
        run: |
          set -euo pipefail
          # Wait up to 3 minutes for kafka-0 to be Ready
          kubectl -n app rollout status statefulset/kafka --timeout=180s
          # Probe admin listener via port-forward (best-effort); don't block if not needed
          POD=$(kubectl -n app get pod -l app=kafka -o jsonpath='{.items[0].metadata.name}')
          kubectl -n app wait --for=condition=Ready pod/$POD --timeout=60s

      - name: ðŸ” Upsert SCRAM-SHA-512 user (idempotent)
        env:
          SASL_USER: ${{ secrets.KAFKA_SASL_USERNAME }}
          SASL_PASS: ${{ secrets.KAFKA_SASL_PASSWORD }}
        run: |
          set -euo pipefail
          if [ -z "${SASL_USER:-}" ] || [ -z "${SASL_PASS:-}" ]; then
            echo "KAFKA_SASL_USERNAME / KAFKA_SASL_PASSWORD secrets are required" >&2
            exit 1
          fi

          # Use a short-lived tools pod to avoid extra memory in broker while updating credentials
          kubectl -n app delete pod kafka-tools --ignore-not-found
          kubectl -n app run kafka-tools --image=apache/kafka:3.8.0 --restart=Never --command -- sleep 600
          kubectl -n app wait --for=condition=Ready pod/kafka-tools --timeout=120s

          # Wait for admin 9094 to respond, then set SCRAM password (creates if absent, updates if present)
          kubectl -n app exec kafka-tools -- bash -lc '
            set -e
            for i in $(seq 1 120); do
              if kafka-topics.sh --bootstrap-server kafka-0.kafka-headless.app.svc.cluster.local:9094 --list >/dev/null 2>&1; then break; fi
              sleep 2
            done
            DESCRIBE=$(kafka-configs.sh --bootstrap-server kafka-0.kafka-headless.app.svc.cluster.local:9094 \
              --describe --entity-type users --entity-name "'$SASL_USER'" || true)
            if echo "$DESCRIBE" | grep -q "Configs for user"; then
              echo "updating password for user: '$SASL_USER'"
            else
              echo "creating user: '$SASL_USER'"
            fi
            kafka-configs.sh --bootstrap-server kafka-0.kafka-headless.app.svc.cluster.local:9094 \
              --alter --add-config "SCRAM-SHA-512=[password='"'$SASL_PASS'"']" \
              --entity-type users --entity-name "'$SASL_USER'"
          '

      - name: ðŸ§¹ Cleanup tools pod
        run: |
          kubectl -n app delete pod kafka-tools --ignore-not-found

      - name: âœ… Summary
        run: |
          echo "Kafka user ensured: ${{ secrets.KAFKA_SASL_USERNAME }} (SCRAM-SHA-512)"
          echo "Bootstrap: kafka.app.svc.cluster.local:9092"

