name: ðŸ§° Bootstrap CoreDNS split-DNS

on:
  workflow_dispatch:
    inputs:
      base_domain:
        description: "Base domain (default: pufferfish.ru)"
        required: false
      ingress_ns:
        description: "Ingress namespace (default: ingress-nginx)"
        required: false
      ingress_svc:
        description: "Ingress service name (default: ingress-nginx-controller)"
        required: false

jobs:
  bootstrap:
    runs-on: [self-hosted]
    steps:
      - name: ðŸ§¾ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ”§ Apply CoreDNS split-DNS
        env:
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
          BASE_DOMAIN: ${{ inputs.base_domain }}
          INGRESS_NS: ${{ inputs.ingress_ns }}
          INGRESS_SVC: ${{ inputs.ingress_svc }}
        run: |
          set -euo pipefail
          chmod +x scripts/coredns-wildcard-pufferfish.sh
          ./scripts/coredns-wildcard-pufferfish.sh

      - name: ðŸ”Ž Sanity checks
        env:
          KUBECONFIG: /etc/rancher/k3s/k3s.yaml
        run: |
          set -e
          echo "Ingress service:" && kubectl -n ingress-nginx get svc ingress-nginx-controller -o wide || true
          echo "CoreDNS cm snippet:" && kubectl -n kube-system get cm coredns -o jsonpath='{.data.Corefile}' | sed -n '1,120p' || true
          echo
          echo "nslookup from a short-lived pod:" && \
            kubectl -n minio run -it --rm dns-smoke --restart=Never --image=busybox:1.36 -- \
            sh -c 'nslookup backminio.pufferfish.ru; nslookup consoleminio.pufferfish.ru' || true

